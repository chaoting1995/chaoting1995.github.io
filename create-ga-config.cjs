const axios = require("axios");
const papa = require("papaparse");
const fs = require("fs");

const filePath = "src/modules/ga4/ga4EventConfig.constants.ts";
const _resources = {};

const CSV_FILE = "https://docs.google.com/spreadsheets/d/13l_6SzrstUe_MjOYyVtBxP9JhAG7jsd6jzufafYmekw/pub?gid=78775188&single=true&output=csv";

axios.get(CSV_FILE).then(res => {
  const parseCsvInfos = papa.parse(res.data);

  const gaKeys = parseCsvInfos.data[0];
  // ["category","action","label","desc","備註"]
  const labelIndex = gaKeys.findIndex(key => key === "label");
  const categoryIndex = gaKeys.findIndex(key => key === "category");
  const actionIndex = gaKeys.findIndex(key => key === "action");

  const gaConfigList = parseCsvInfos.data.filter((_, index) => index !== 0);
  gaConfigList.forEach(item => {
    _resources[item[labelIndex]] = {
      category: item[categoryIndex],
      action: item[actionIndex],
      label: item[labelIndex],
    };
  });

  fs.writeFileSync(
    filePath,
    `// Code generated by create-ga-config.cjs, DO NOT EDIT.
// You can use 'pnpm ga-config'.
const GA_EVENT_STRING = ${JSON.stringify(_resources, null, "  ")};
export default GA_EVENT_STRING;
`,
    "utf8",
  );
});
